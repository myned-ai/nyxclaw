# ==============================================================================
# NyxClaw - Docker Compose Configuration
# ==============================================================================
#
# Usage:
#   Production:  docker-compose up -d
#   Development: docker-compose --profile dev up
#   Logs:        docker-compose logs -f
#   Stop:        docker-compose down
#
# ==============================================================================

services:
  # ============================================================================
  # NyxClaw (Production)
  # ============================================================================
  server:
    build:
      context: .
      target: production
      args:
        INSTALL_LOCAL_VOICE: ${INSTALL_LOCAL_VOICE:-false}
    container_name: nyxclaw
    ports:
      - "8081:8080"
    environment:
      - ASSISTANT_INSTRUCTIONS=${ASSISTANT_INSTRUCTIONS:-You are a helpful and friendly AI assistant.}
      - ONNX_MODEL_PATH=/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - AUTH_ENABLED=false
      - DEBUG=${DEBUG:-false}
      - DEBUG_AUDIO_CAPTURE=${DEBUG_AUDIO_CAPTURE:-false}
      # Agent Configuration
      - AGENT_TYPE=${AGENT_TYPE:-openclaw}
      # Agent Backend Configuration
      - BASE_URL=${BASE_URL:-http://host.docker.internal:19001}
      - AUTH_TOKEN=${AUTH_TOKEN}
      - AGENT_MODEL=${AGENT_MODEL:-openclaw:main}
      - USER_ID=${USER_ID}
      - THINKING_MODE=${THINKING_MODE:-minimal}
      - SESSION_KEY=${SESSION_KEY}
      - AGENT_ID=${AGENT_ID}
      - MAX_RETRIES=${MAX_RETRIES:-2}
      # STT/TTS Configuration
      - STT_ENABLED=${STT_ENABLED:-true}
      - STT_MODEL=${STT_MODEL:-small.en}
      - STT_VAD_START_THRESHOLD=${STT_VAD_START_THRESHOLD:-0.60}
      - STT_VAD_END_THRESHOLD=${STT_VAD_END_THRESHOLD:-0.35}
      - STT_VAD_MIN_SILENCE_MS=${STT_VAD_MIN_SILENCE_MS:-500}
      - STT_INITIAL_PROMPT=${STT_INITIAL_PROMPT:-}
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_ONNX_MODEL_DIR=${TTS_ONNX_MODEL_DIR:-/app/pretrained_models/piper}
      - TTS_VOICE_NAME=${TTS_VOICE_NAME:-en_US-hfc_female-medium}
      - TTS_VOICE_PATH=${TTS_VOICE_PATH}
      - TTS_NOISE_SCALE=${TTS_NOISE_SCALE:-0.75}
      - TTS_NOISE_W_SCALE=${TTS_NOISE_W_SCALE:-0.8}
      - TTS_LENGTH_SCALE=${TTS_LENGTH_SCALE:-0.95}
    volumes:
      - ./pretrained_models/wav2arkit/wav2arkit_cpu.onnx:/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx:ro
      - ./pretrained_models/wav2arkit/wav2arkit_cpu.onnx.data:/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx.data:ro
      - ./pretrained_models/piper:/app/pretrained_models/piper:ro
      - ./pretrained_models/faster_whisper_small_en:/app/pretrained_models/faster_whisper_small_en:ro
      - ./pretrained_models/silero_vad.onnx:/app/pretrained_models/silero_vad.onnx:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # NyxClaw (Development with hot reload)
  # ============================================================================
  server-dev:
    build:
      context: .
      target: development
      args:
        INSTALL_LOCAL_VOICE: ${INSTALL_LOCAL_VOICE:-false}
    container_name: nyxclaw-dev
    profiles:
      - dev
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      - ASSISTANT_INSTRUCTIONS=${ASSISTANT_INSTRUCTIONS:-You are a helpful and friendly AI assistant.}
      - ONNX_MODEL_PATH=/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - AUTH_ENABLED=false
      - DEBUG=true
      # Agent Configuration
      - AGENT_TYPE=${AGENT_TYPE:-openclaw}
      # Agent Backend Configuration
      - BASE_URL=${BASE_URL:-http://host.docker.internal:19001}
      - AUTH_TOKEN=${AUTH_TOKEN}
      - AGENT_MODEL=${AGENT_MODEL:-openclaw:main}
      - USER_ID=${USER_ID}
      - THINKING_MODE=${THINKING_MODE:-minimal}
      - SESSION_KEY=${SESSION_KEY}
      - AGENT_ID=${AGENT_ID}
      - MAX_RETRIES=${MAX_RETRIES:-2}
      # STT/TTS Configuration
      - STT_ENABLED=${STT_ENABLED:-true}
      - STT_MODEL=${STT_MODEL:-small.en}
      - STT_VAD_START_THRESHOLD=${STT_VAD_START_THRESHOLD:-0.60}
      - STT_VAD_END_THRESHOLD=${STT_VAD_END_THRESHOLD:-0.35}
      - STT_VAD_MIN_SILENCE_MS=${STT_VAD_MIN_SILENCE_MS:-500}
      - STT_INITIAL_PROMPT=${STT_INITIAL_PROMPT:-}
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_ONNX_MODEL_DIR=${TTS_ONNX_MODEL_DIR:-/app/pretrained_models/piper}
      - TTS_VOICE_NAME=${TTS_VOICE_NAME:-en_US-hfc_female-medium}
      - TTS_VOICE_PATH=${TTS_VOICE_PATH}
      - TTS_NOISE_SCALE=${TTS_NOISE_SCALE:-0.75}
      - TTS_NOISE_W_SCALE=${TTS_NOISE_W_SCALE:-0.8}
      - TTS_LENGTH_SCALE=${TTS_LENGTH_SCALE:-0.95}
    volumes:
      - .:/app
      - ./pretrained_models/wav2arkit/wav2arkit_cpu.onnx:/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx:ro
      - ./pretrained_models/wav2arkit/wav2arkit_cpu.onnx.data:/app/pretrained_models/wav2arkit/wav2arkit_cpu.onnx.data:ro
      - ./pretrained_models/piper:/app/pretrained_models/piper:ro
      - ./pretrained_models/faster_whisper_small_en:/app/pretrained_models/faster_whisper_small_en:ro
      - ./pretrained_models/silero_vad.onnx:/app/pretrained_models/silero_vad.onnx:ro
    command: uv run uvicorn src.main:app --host 0.0.0.0 --port 8080 --reload
